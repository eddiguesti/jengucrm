name = "jengu-crm"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# ============================================
# ENVIRONMENT VARIABLES (set via wrangler secret)
# ============================================
# REQUIRED - Run these after first deploy:
#   wrangler secret put GROK_API_KEY        # x.ai API key for Grok (email generation + website finder)
#
# SUPABASE (for mailboxes table - managed via UI at /outreach/mailboxes):
#   wrangler secret put SUPABASE_URL              # e.g., https://xxx.supabase.co
#   wrangler secret put SUPABASE_SERVICE_ROLE_KEY # Service role key (not anon key!)
#
# LEGACY (fallback if Supabase not configured):
#   wrangler secret put SMTP_INBOX_1        # format: email|password|host|port|displayName
#   wrangler secret put SMTP_INBOX_2
#   wrangler secret put SMTP_INBOX_3
#
# ENRICHMENT (for finding websites and emails):
#   wrangler secret put MILLIONVERIFIER_API_KEY  # For email pattern verification
#
# OPTIONAL:
#   wrangler secret put ANTHROPIC_API_KEY   # AI fallback
#   wrangler secret put RESEND_API_KEY      # For Resend sending (pro setup)
#   wrangler secret put ALERT_WEBHOOK_URL   # Slack/Discord alerts
#
# NOTE: Mailboxes are now managed via the Supabase 'mailboxes' table.
#       The UI at /outreach/mailboxes lets you add/edit/remove mailboxes.
#       SMTP_INBOX_* env vars are only used as fallback if Supabase is not set up.

# ============================================
# D1 DATABASE
# ============================================
[[d1_databases]]
binding = "DB"
database_name = "jengu-crm"
database_id = "c97651e6-10a6-496f-9ca9-c599a954c535"

# ============================================
# KV NAMESPACES (Config & Cache)
# ============================================
[[kv_namespaces]]
binding = "KV_CONFIG"
id = "2e46e9da15dc4e8e9fae31e3df55c446"

[[kv_namespaces]]
binding = "KV_CACHE"
id = "f16f5b6e2511482abb881e3212a9bca8"

# ============================================
# DURABLE OBJECTS
# ============================================
[durable_objects]
bindings = [
  { name = "WARMUP_COUNTER", class_name = "WarmupCounter" },
  { name = "INBOX_STATE", class_name = "InboxState" },
  { name = "RATE_LIMITER", class_name = "RateLimiter" },
  { name = "PROSPECT_DEDUP", class_name = "ProspectDedup" },
]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["WarmupCounter", "InboxState", "RateLimiter", "ProspectDedup"]

# ============================================
# CRON TRIGGERS
# ============================================
# Note: Reply checking is handled by Cloudflare Email Routing (real-time)
[triggers]
crons = [
  "*/5 8-18 * * 1-6",  # Every 5 min, 8am-6pm, Mon-Sat (email sending)
  "0 7 * * *",         # 7am daily (pipeline: reset counters, cleanup)
  "0 10 * * 1-5",      # 10am weekdays (follow-ups)
  "*/5 6,19-23 * * *", # Every 5 min, 6am + 7pm-11pm (enrichment: find websites/emails)
  "2-59/10 * * * *",   # Every 10 min at :02/:12/... (trigger Sales Navigator enrichment on Vercel)
]

# ============================================
# EMAIL ROUTING (Inbound Email Handling)
# ============================================
# Enable this after setting up Email Routing in Cloudflare dashboard:
# 1. Go to your domain > Email > Email Routing
# 2. Create a catch-all rule pointing to this worker
# The email() handler in src/index.ts will process inbound emails
#
# Alternatively, forward specific addresses:
# [[email_routing]]
# enabled = true

# ============================================
# SMART PLACEMENT (run near data)
# ============================================
[placement]
mode = "smart"

[vars]
# Vercel DDG search proxy - search DuckDuckGo via Vercel IPs (Cloudflare IPs get blocked)
VERCEL_SEARCH_URL = "https://crm.jengu.ai/api/search"

# Vercel/Next.js app base URL (for cron-triggering Supabase-backed jobs)
VERCEL_APP_URL = "https://crm.jengu.ai"
